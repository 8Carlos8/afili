<?php
require_once('../Logica/Licencia.php');
require_once('../Logica/Afiliado.php');
require_once('../Sesion/header.php');

$licencia = new Licencia();
$afiliado = new Afiliado();
$licencias = $licencia->lista();
$afiliados = $afiliado->lista();
if (isset($_POST['id'])) {
    $licencia->insertarRegistro();
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/style.css">
    <script src="../scripts/buscarAfiliado.js"></script>
    <title>Insertar Licencia</title>
</head>
<body>
    <div class="container py-3">
        <div class="form-group text-center">
            <a href="index.php" class="btn btn-success">&nbsp;Lista de Licencias</a>
        </div>
        <form name="frmInsLic" action="insertar.php" method="post" enctype="multipart/form-data">
            <input type="hidden" name="id" value="0">
            <div class="form-group">
                <label>ID Afiliado</label>
                <input type="text" id="buscar_afiliado" onkeyup="filtrarAfiliado()" class="form-control mt-2" placeholder="Buscar Afiliado">
                <br>
                <select name="id_afiliado" id="id_afiliado" class="form-control">
                    <option value="">Seleccionar Afiliado</option>
                    <?php foreach($afiliados as $afiliado) {?>
                        <option value="<?= $licencia->id ?>"><?= $afiliado->nombre . " " . $afiliado->apellido_paterno . " " . $afiliado->apellido_materno ?></option>
                    <?php } ?>
                </select>
                <br>
                <select name="tipo" id="tipo" class="form-control">
                    <option value="">Tipo de Licencia</option>
                    <option value="Refrendo De Giros Normales">Refrendo De Giros Normales</option>
                    <option value="Refrendo De Bebidas Alcoholicas">Refrendo De Bebidas Alcohólicas</option>
                    <option value="Apertura Ordinaria">Apertura Ordinaria</option>
                    <option value="Apertura Rapida">Apertura Rápida</option>
                </select>
            </div>
            <div class="form-group">
                <label>Fecha</label>
                <input type="date" name="fecha" id="fecha" class="form-control" >
            </div>
            <div class="form-group">
                <label>Licencia</label>
                <input type="file" name="licencia" id="licencia" class="form-control" accept="application/pdf">
            </div>
            <div class="form-group text-center">
                <button type="submit" class="btn btn-primary">&nbsp;Registrar</button>
            </div>
        </form>
    </div>
</body>
</html>








<?php
require_once('Modelo.php');

class Licencia extends Modelo{
    public $id;
    public $id_afiliado;
    public $tipo;
    public $fecha;
    public $licencia;

    function __construct(){
        parent::__construct();
        $this->tabla = "licencia";
    }

    function lista(){
        $this->consulta = "select * from $this->tabla";
        return $this->encuentraTodos();
    }

    function recuperarAfiliado($id_afiliado){
        $this->consulta = "select * from $this->tabla where id_afiliado = $id_afiliado";
        return $this->encuentraTodos();
    }

    function recuperarRegistro($id){
        $this->consulta = "select * from $this->tabla where id = $id";
        $dato = $this->encuentraUno();
        if (isset($dato)) {
            $this->id = $dato->id;
            $this->id_afiliado = $dato->id_afiliado;
            $this->tipo = $dato->tipo;
            $this->fecha = $dato->fecha;
            $this->licencia = $dato->licencia; 
        }
        return $dato;
    }

    function recuperarLicenciaPorId($id){
        $this->consulta = "select licencia from $this->tabla where id = $id";
        $dato = $this->encuentraUno();
        if (isset($dato)) {
            $this->licencia = $dato->licencia;
        }
        return $dato ? $dato->licencia : null;
    }

    function insertarRegistro(){
        $this->id = $_POST['id'];
        $this->id_afiliado = $_POST['id_afiliado'];
        $this->tipo = $_POST['tipo'];
        $this->fecha = $_POST['fecha'];


        if (is_uploaded_file($_FILES['licencia']['tmp_name'])) {
            $file_tmp = $_FILES['licencia']['tmp_name'];
            $this->licencia = file_get_contents($file_tmp);
        } else {
            echo "Error: El archivo no fue cargado correctamente.";
            return;
        }

        $licencia_escaped = addslashes($this->licencia);

        $this->consulta =
        "insert into $this->tabla (id_afiliado, tipo, fecha, licencia)".
        "values (".
        "$this->id_afiliado,".
        "'$this->tipo'," .
        "$this->fecha," .
        "'$licencia_escaped');";

        $this->ejecutaComandoIUD();
    }

    function actualizaRegistro(){
        $this->id = $_POST['id'];
        $this->id_afiliado = $_POST['id_afiliado'];
        $this->tipo = $_POST['tipo'];
        $this->fecha = $_POST['fecha'];
        $this->licencia = isset($_FILES['licencia']['name']) ? $_FILES['licencia']['name'] : null;

        if (is_uploaded_file($_FILES['licencia']['tmp_name'])) {
            $file_tmp = $_FILES['licencia']['tmp_name'];
            $this->licencia = file_get_contents($file_tmp);

            $licencia_escaped = addslashes($this->licencia);

            $this->consulta =
            "update $this->tabla set ".
            "id_afiliado = $this->id_afiliado, ".
            "tipo = $this->tipo, ".
            "fecha = $this->fecha, ".
            "licencia '$licencia_escaped' ".
            "where id = $this->id";
        } else {
            $this->consulta =
            "update $this->tabla set ".
            "id_afiliado = $this->id_afiliado ".
            "where id = $this->id";
        }

        $this->ejecutaComandoIUD();
    }

    function eliminaRegistro($id){
        $this->consulta =
        "delete from $this->tabla ".
        "where id = $id;";

        $this->ejecutaComandoIUD();
    }
}
?>